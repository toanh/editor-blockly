<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Blockly Fan Control Checker with Centered Dialog in Workspace</title>
    <!-- Include the Blockly library from a CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
      /* Basic page styling */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      /* Position the Run button at the top left */
      #runButton {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        padding: 8px 16px;
        font-size: 16px;
      }
      /* Container for the workspace and dialog */
      #workspaceContainer {
        position: relative;
        width: 400px;
        height: 400px;
        top: 50px; /* leave room for the Run button */
        left: 10px;
        border: 1px solid #ccc; /* Optional border for visual clarity */
      }
      /* Blockly workspace should fill the container */
      #blocklyDiv {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      /* Custom dialog centered within the workspace container */
      #resultDialog {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;       /* Maximum width 300px */
        height: 100px;      /* Maximum height 100px */
        background: #fff;
        border: 2px solid #ccc;
        padding: 20px;
        display: none;      /* Hidden by default */
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        border-radius: 8px;
        font-family: sans-serif;
        z-index: 2000;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
      }
      /* Container for the icon and message in the dialog (row layout) */
      .resultContent {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      /* Icon styling: ensure it stays to the left and is appropriately sized */
      #resultDialog .icon {
        font-size: 48px; /* Adjust icon size as needed */
        flex-shrink: 0;
      }
      /* Message styling */
      #resultDialog .msg {
        font-size: 16px; /* Adjust text size as needed */
        flex-grow: 1;
        word-wrap: break-word;
      }
      /* OK button styling */
      #resultDialog button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        align-self: center;
      }
    </style>
  </head>
  <body>
    <!-- Run button -->
    <button id="runButton">Run</button>
    <!-- Container for the Blockly workspace and dialog -->
    <div id="workspaceContainer">
      <!-- Blockly workspace -->
      <div id="blocklyDiv"></div>
      <!-- Custom result dialog with OK button (hidden by default) -->
      <div id="resultDialog">
        <!-- Row container: icon on the left and message on the right -->
        <div class="resultContent">
          <div class="icon"></div>
          <div class="msg"></div>
        </div>
        <button id="okButton">OK</button>
      </div>
    </div>

    <!-- Define the Blockly toolbox XML -->
    <xml id="toolbox" style="display: none">
      <!-- Standard if block (if-then) -->
      <block type="controls_if"></block>
      <!-- Custom condition blocks -->
      <block type="condition_i_am_cold"></block>
      <block type="condition_i_am_hot"></block>
      <!-- Custom action block -->
      <block type="action_turn_on_fan"></block>
    </xml>

    <script>
      // --- Define Custom Blocks ---

      // "i am cold" condition block.
      Blockly.Blocks['condition_i_am_cold'] = {
        init: function() {
          this.appendDummyInput().appendField("i am cold");
          this.setOutput(true, "Boolean");
          this.setColour(210);
          this.setTooltip("Returns true if you are cold.");
          this.setHelpUrl("");
        }
      };

      // "i am hot" condition block.
      Blockly.Blocks['condition_i_am_hot'] = {
        init: function() {
          this.appendDummyInput().appendField("i am hot");
          this.setOutput(true, "Boolean");
          this.setColour(210);
          this.setTooltip("Returns true if you are hot.");
          this.setHelpUrl("");
        }
      };

      // "turn on the fan" action block.
      Blockly.Blocks['action_turn_on_fan'] = {
        init: function() {
          this.appendDummyInput().appendField("turn on the fan");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(120);
          this.setTooltip("Executes the action to turn on the fan.");
          this.setHelpUrl("");
        }
      };

      // --- Define JavaScript Generators for the Blocks ---
      Blockly.JavaScript['condition_i_am_cold'] = function(block) {
        var code = 'iAmCold()';
        return [code, Blockly.JavaScript.ORDER_NONE];
      };

      Blockly.JavaScript['condition_i_am_hot'] = function(block) {
        var code = 'iAmHot()';
        return [code, Blockly.JavaScript.ORDER_NONE];
      };

      Blockly.JavaScript['action_turn_on_fan'] = function(block) {
        var code = 'turnOnFan();\n';
        return code;
      };

      // --- Inject Blockly into the page with trashcan enabled ---
      var workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        trashcan: true
      });

      // Function to display the result in the custom dialog.
      // If type is "correct", a green tick is shown;
      // if type is "snowman", a snowman icon is shown;
      // otherwise, a red cross is shown.
      function showResult(message, type) {
        var dialog = document.getElementById("resultDialog");
        var iconDiv = dialog.querySelector(".icon");
        var msgDiv = dialog.querySelector(".msg");

        if (type === "correct") {
          iconDiv.innerHTML = "&#x2714;";  // Unicode check mark.
          iconDiv.style.color = "green";
        } else if (type === "snowman") {
          iconDiv.innerHTML = "&#9731;";  // Unicode snowman.
          iconDiv.style.color = "blue";
        } else {
          iconDiv.innerHTML = "&#x2716;";  // Unicode heavy ballot X.
          iconDiv.style.color = "red";
        }
        msgDiv.textContent = message;

        // Display the dialog (centered within the workspace container)
        dialog.style.display = "flex";
      }

      // Dismiss the dialog when the OK button is clicked.
      document.getElementById("okButton").addEventListener("click", function() {
        document.getElementById("resultDialog").style.display = "none";
      });

      // --- Check the user's block configuration ---
      function checkBlocks() {
        // Get all top-level blocks in the workspace.
        var topBlocks = workspace.getTopBlocks(true);
        // There must be exactly one top-level block.
        if (topBlocks.length !== 1) {
          showResult("Not quite, try again!", "incorrect");
          return;
        }
        var block = topBlocks[0];
        // The top block must be an if block.
        if (block.type !== 'controls_if') {
          showResult("Not quite, try again!", "incorrect");
          return;
        }
        // Get the condition ("IF0") and the statement ("DO0") blocks.
        var conditionBlock = block.getInputTargetBlock("IF0");
        var actionBlock = block.getInputTargetBlock("DO0");

        // Ensure that no extra blocks are attached.
        if (block.getNextBlock() || (actionBlock && actionBlock.getNextBlock())) {
          showResult("Not quite, try again!", "incorrect");
          return;
        }

        // Branch based on the type of condition block.
        if (conditionBlock && conditionBlock.type === "condition_i_am_hot" && actionBlock && actionBlock.type === "action_turn_on_fan") {
          // Correct configuration: i am hot.
          showResult("Correct", "correct");
        } else if (conditionBlock && conditionBlock.type === "condition_i_am_cold" && actionBlock && actionBlock.type === "action_turn_on_fan") {
          // Special case: i am cold.
          showResult("You must be a snowman to want the fan on when you are cold!", "snowman");
        } else {
          showResult("Not quite, try again!", "incorrect");
        }
      }

      // Attach the checkBlocks function to the Run button.
      document.getElementById("runButton").addEventListener("click", checkBlocks);
    </script>
  </body>
</html>
